<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Результаты опроса</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Shared styles - could also be in a separate results.css */
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        #chart-container {
            height: 350px;
            position: relative;
        }
         body { background-color: #f9fafb; /* bg-gray-50 */ }
    </style>
</head>
<body class="min-h-screen font-sans">
    <!-- Страница результатов -->
    <div id="results-container" class="max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <div class="mx-auto h-16 w-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-chart-pie text-indigo-600 text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Результаты опроса</h1>
            <p class="text-lg text-gray-600">Статистика использования смартфонов</p>
        </div>

        <div class="bg-white shadow rounded-lg overflow-hidden p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 text-center md:text-left">Распределение ответов</h2>

            <div class="flex flex-col md:flex-row gap-8 items-center md:items-start">
                <div id="chart-container" class="w-full md:w-1/2 lg:w-2/5 flex-shrink-0">
                    <canvas id="results-chart"></canvas>
                </div>

                <div class="w-full md:w-1/2 lg:w-3/5">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Детальная статистика (<span id="total-answers-detail">0</span> ответов)</h3>
                    <div class="space-y-4">
                        <!-- Progress Bar Item -->
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">Менее 1 часа</span>
                                <span id="less-1-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="less-1-bar" class="progress-bar bg-red-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="less-1-count">0</span> ответов</div>
                        </div>
                        <!-- Repeat for other options -->
                         <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">1–2 часа</span>
                                <span id="1-2-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="1-2-bar" class="progress-bar bg-orange-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="1-2-count">0</span> ответов</div>
                        </div>
                         <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">2–4 часа</span>
                                <span id="2-4-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="2-4-bar" class="progress-bar bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="2-4-count">0</span> ответов</div>
                        </div>
                         <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">4–6 часов</span>
                                <span id="4-6-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="4-6-bar" class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="4-6-count">0</span> ответов</div>
                        </div>
                         <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">Более 6 часов</span>
                                <span id="more-6-percent" class="text-sm font-medium text-gray-700">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="more-6-bar" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 mt-1"><span id="more-6-count">0</span> ответов</div>
                        </div>
                    </div>
                     <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Сводка</h3>
                         <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Среднее время:</span>
                                <span id="average-time" class="font-medium text-gray-900">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Самая популярная категория:</span>
                                <span id="popular-category" class="font-medium text-gray-900">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

         <div class="bg-white shadow rounded-lg overflow-hidden p-6">
             <h3 class="text-lg font-medium text-gray-900 mb-4">Интересные факты</h3>
             <ul class="space-y-3 text-sm text-gray-600">
                 <li class="flex items-start">
                     <i class="fas fa-info-circle text-indigo-500 mt-1 mr-2 flex-shrink-0"></i>
                     <span>Средний пользователь смартфона проверяет его <span class="font-medium">58 раз</span> в день.</span>
                 </li>
                 <li class="flex items-start">
                     <i class="fas fa-info-circle text-indigo-500 mt-1 mr-2 flex-shrink-0"></i>
                     <span><span class="font-medium">80%</span> времени использования приходится на 5 самых популярных приложений.</span>
                 </li>
                 <li class="flex items-start">
                     <i class="fas fa-info-circle text-indigo-500 mt-1 mr-2 flex-shrink-0"></i>
                     <span>В среднем человек проводит <span class="font-medium">~3 часа 15 минут</span> в день со смартфоном.</span>
                 </li>
             </ul>
         </div>

        <div class="mt-8 text-center">
             <!-- Direct link back to poll -->
            <a href="poll.html" class="text-indigo-600 hover:text-indigo-800 font-medium">Вернуться к опросу</a>
        </div>
    </div>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Include common logic -->
    <script src="poll_logic.js"></script>
    <!-- Page-specific script for results -->
    <script>
        let resultsChart = null;

        function updateResultsDisplay() {
            // pollData is loaded by poll_logic.js included above
            const total = pollData.total;
            const answers = pollData.answers;
            console.log("Updating results display with data:", JSON.stringify(pollData));

            document.getElementById('total-answers-detail').textContent = total;

            const ids = { 1: 'less-1', 2: '1-2', 3: '2-4', 4: '4-6', 5: 'more-6' };

            // Update counts, percentages, and bars
            for (const option in ids) {
                if (ids.hasOwnProperty(option)) {
                    const prefix = ids[option];
                    const count = answers[option] || 0; // Default to 0 if missing
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;

                    document.getElementById(`${prefix}-count`).textContent = count;
                    document.getElementById(`${prefix}-percent`).textContent = percentage + '%';

                    const barElement = document.getElementById(`${prefix}-bar`);
                    // Use timeout for CSS transition animation
                    setTimeout(() => {
                        if(barElement) barElement.style.width = percentage + '%';
                    }, 100);
                }
            }

             // Calculate and display average time
            if (total > 0) {
                const weightedSum =
                    (answers[1] || 0) * 0.5 +
                    (answers[2] || 0) * 1.5 +
                    (answers[3] || 0) * 3.0 +
                    (answers[4] || 0) * 5.0 +
                    (answers[5] || 0) * 7.0;
                const average = weightedSum / total;
                document.getElementById('average-time').textContent = average.toFixed(1) + ' ч.';
            } else {
                 document.getElementById('average-time').textContent = '-';
            }

             // Find and display the most popular category
            if (total > 0) {
                let maxCount = -1;
                let popularOption = 0;
                for (const option in answers) {
                     if (answers.hasOwnProperty(option) && answers[option] > maxCount) {
                        maxCount = answers[option];
                        popularOption = parseInt(option);
                    }
                }
                 document.getElementById('popular-category').textContent = getAnswerText(popularOption); // Use helper
            } else {
                 document.getElementById('popular-category').textContent = '-';
            }

            // Update the chart
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('results-chart').getContext('2d');

            if (resultsChart) {
                resultsChart.destroy();
            }

             const chartColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'];
             const chartData = [
                pollData.answers[1] || 0,
                pollData.answers[2] || 0,
                pollData.answers[3] || 0,
                pollData.answers[4] || 0,
                pollData.answers[5] || 0
             ];
             const chartLabels = [
                getAnswerText(1), getAnswerText(2), getAnswerText(3), getAnswerText(4), getAnswerText(5)
             ];


            resultsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Количество ответов',
                        data: chartData,
                        backgroundColor: chartColors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15, font: { size: 12 } } },
                        tooltip: {
                             backgroundColor: '#111827', titleFont: { size: 14 }, bodyFont: { size: 12 }, padding: 10,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const currentTotal = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); // Recalculate total from chart data
                                    const percentage = currentTotal > 0 ? Math.round((value / currentTotal) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
             console.log("Chart rendered with data:", chartData);
        }

        // --- Initialization on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Results page loaded.");
            loadPollData(); // Load the data from localStorage via common logic
            updateResultsDisplay(); // Update visuals based on loaded data
        });
    </script>
</body>
</html>